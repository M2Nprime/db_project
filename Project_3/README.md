# پروژه شماره ۳: کار با پایگاه داده فیلم با استفاده از Django ORM

این پروژه به عنوان بخشی از پروژه پایانی درس پایگاه داده پیاده‌سازی شده است. در این پروژه، یک سیستم مدیریت فیلم با استفاده از ORM فریمورک جنگو پیاده‌سازی شده است که به پایگاه داده از قبل طراحی شده در پروژه شماره ۲ متصل می‌شود.

---

## ۱. ساختار مدل‌ها

ساختار پایگاه داده شامل مدل‌های اصلی زیر است که در فایل `movies/models.py` تعریف شده‌اند:

* **Movie**: اطلاعات اصلی فیلم‌ها را شامل می‌شود و با کارگردان (`ForeignKey` به `Person`) در ارتباط است.
* **Person**: اطلاعات اشخاص (کارگردانان و بازیگران) را ذخیره می‌کند.
* **Genre**: ژانرهای مختلف فیلم‌ها را نگهداری می‌کند.
* **MovieActor** و **MovieGenre**: جداول واسط برای مدیریت روابط چندبه‌چند بین فیلم‌ها و بازیگران/ژانرها.
* **User** و **Rating**: جداول آماده برای پیاده‌سازی سیستم کاربران و امتیازدهی در آینده.

---

## ۲. نحوه اجرای پروژه

برای اجرای این پروژه، مراحل زیر را دنبال کنید:

**۱. پیش‌نیازها:**
* پایتون ۳.۱۰ یا بالاتر
* نصب بودن MySQL Server
* ایجاد و پر کردن پایگاه داده با استفاده از اسکریپت‌های پروژه شماره ۲ (`schema.sql` و `importer_populate_db.py`).

**۲. راه‌اندازی محیط:**
* وارد پوشه `Project_3` شوید.
* یک محیط مجازی ساخته و آن را فعال کنید:
    ```bash
    python -m venv venv
    .\venv\Scripts\activate
    ```
* با استفاده از فایل `requirements.txt`، کتابخانه‌های مورد نیاز را نصب کنید:
    ```bash
    pip install -r requirements.txt
    ```

**۳. تنظیمات:**
* فایل `movieproject/settings.py` را باز کرده و اطلاعات اتصال به پایگاه داده (`DATABASES`) را با مشخصات خودتان جایگزین کنید.

**۴. اجرای کوئری‌ها:**
* برای مشاهده نمونه کوئری‌های پروژه، دستور زیر را اجرا کنید:
    ```bash
    python run_queries.py
    ```

**۵. مشاهده پنل ادمین (امتیاز اضافه):**
* ابتدا یک ابرکاربر (superuser) بسازید و سپس سرور را اجرا کنید.
    ```bash
    python manage.py createsuperuser
    python manage.py runserver
    ```
* سپس در مرورگر به آدرس `http://127.0.0.1:8000/admin/` بروید و با اطلاعات ابرکاربر وارد شوید.

---

## ۳. نمونه کوئری‌های ORM

در فایل `run_queries.py` تمام ۱۰ کوئری پیاده‌سازی شده است. در ادامه چند نمونه کلیدی آورده شده است:

**کوئری ۳: پیدا کردن ۱۰ بازیگر برتر بر اساس تعداد فیلم**
* **توضیح:** این کوئری با استفاده از `annotate` و `Count`، برای هر شخص تعداد فیلم‌هایش را محاسبه کرده و ۱۰ نفر برتر را برمی‌گرداند.
* **کد:**
    ```python
    from django.db.models import Count
    top_actors = Person.objects.annotate(
        movie_count=Count('movieactor__movieid')
    ).order_by('-movie_count')[:10]
    ```

**کوئری ۵: فیلم‌های بسیار طولانی یا با نمره بسیار بالا**
* **توضیح:** این کوئری با استفاده از آبجکت `Q`، یک شرط `OR` را پیاده‌سازی می‌کند.
* **کد:**
    ```python
    from django.db.models import Q
    long_or_high_rated_movies = Movie.objects.filter(
        Q(durationinminutes__gt=180) | Q(tmdbscore__gt=8.5)
    )
    ```

**کوئری ۱۰: بهینه‌سازی عملکرد با `prefetch_related`**
* **توضیح:** این کوئری برای حل مشکل N+1، ابتدا کارگردانان برتر را پیدا کرده و سپس با استفاده از `prefetch_related`، تمام فیلم‌های مربوط به آن‌ها را تنها با یک کوئری اضافه واکشی می‌کند.
* **کد:**
    ```python
    top_directors = Person.objects.annotate(
        movie_count=Count('movie')
    ).order_by(
        '-movie_count'
    ).prefetch_related('movie_set')[:5]
    ```

---

## ۴. توسعه بیشتر

علاوه بر کوئری‌ها، قابلیت‌های زیر نیز طبق نیازمندی‌های پروژه پیاده‌سازی شده‌اند:

* **متد سفارشی:** یک متد به نام `get_duration_display` به مدل `Movie` اضافه شده است که مدت زمان فیلم به دقیقه را به فرمت خوانا (مثلاً "2h 22m") تبدیل می‌کند.
* **پراپرتی سفارشی:** یک پراپرتی به نام `age` به مدل `Person` اضافه شده است که سن شخص را به صورت پویا بر اساس تاریخ تولد او محاسبه می‌کند.
* **سیگنال‌ها:** سیگنال‌های `post_save` و `pre_delete` برای مدل `Movie` پیاده‌سازی شده‌اند که در هنگام ساخته شدن یا قبل از حذف شدن یک فیلم، پیامی را در کنسول چاپ می‌کنند.
